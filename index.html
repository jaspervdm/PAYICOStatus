<html>
  <head>
    <title>TenX PAY ICO status</title>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/web3/dist/web3.min.js"></script>
    <script src="tenxabi.js"></script>
    <script>
      var web3, saleContract, rateContract, tokenContract;

      var saleStart, hardcap, vault, vaultBalance, altDeposits;

      var nodeURL = 'ENTER_YOUR_NODE_URL_HERE';
      var ourAddr = 'ENTER_YOUR_ADDRESS_HERE';

      var saleAddr = '0xd43D09Ec1bC5e57C8F3D0c64020d403b04c7f783';
      var tokenAddr = '0xB97048628DB6B661D4C2aA833e95Dbe1A905B280';
      var rateAddr = '0x31E89d5186fA7AA857bF81E3bAD5E183a006900C';

      var formatThousandsNoRounding = function(n, dp){
        var e = '', s = e+n, l = s.length, b = n < 0 ? 1 : 0,
            i = s.lastIndexOf('.'), j = i == -1 ? l : i,
            r = e, d = s.substr(j+1, dp);
        while ( (j-=3) > b ) { r = ',' + s.substr(j, 3) + r; }
        return s.substr(0, j + 3) + r + 
          (dp ? '.' + d + ( d.length < dp ? 
              ('00000').substr(0, dp - d.length):e):e);
      };

      function updateRaised() {
        if (saleStart && hardcap && vaultBalance && altDeposits) {
          var now = Math.floor(Date.now()/1000);
          if (now >= saleStart) {
            if (web3.toBigNumber(vaultBalance).plus(web3.toBigNumber(altDeposits)).lte(web3.toBigNumber(hardcap)) && now < saleStart + 28*24*60*60) {
              $('#status').html('<span class="started">STARTED</span>');
            }
            else {
              $('#status').html('<span class="post">ENDED</span>');
            }
          }
          else {
            $('#status').html('<span class="pre">Not started</span>');
          }
        }
        else {
          $('#status').html('?');
        }

        if (vaultBalance && altDeposits) {
          var raised = web3.toBigNumber(vaultBalance).plus(web3.toBigNumber(altDeposits));
          $('#raised').html(''+ formatThousandsNoRounding(web3.fromWei(raised, 'ether'), 3)+' ETH');
          if (hardcap) {
            $('#raised_perc').html('['+raised.dividedBy(web3.toBigNumber(hardcap)).times(100).toNumber().toFixed(2)+'%]');
          }
        }
      }

      function update() {
        // Update sale start time
        saleContract.start(function (error, result) {
          if (!error) {
            saleStart = result;
            var start = new Date(result*1000);
            $('#start').html(String('00'+start.getDate()).slice(-2)+'-'+String('00'+start.getMonth()).slice(-2)+'-'+start.getFullYear()+' '+String('00'+start.getHours()).slice(-2)+':'+String('00'+start.getMinutes()).slice(-2)+':'+String('00'+start.getSeconds()).slice(-2));
          }
          else {
            console.log('Error: '+error);
          }
        });

        // Update vault balance
        saleContract.multisigVault(function (error, result) {
          if (!error) {
            vault = result;
            web3.eth.getBalance(vault, function (error, result) {
              if (!error) {
                vaultBalance = result;
                $('#raised_eth').html(''+formatThousandsNoRounding(web3.fromWei(result, 'ether'), 3)+' ETH');
                updateRaised();
              }
              else {
                console.log('Error: '+error);
              }
            });
          }
          else {
            console.log('Error: '+error);
          }
        });

        // Update alt deposits
        saleContract.altDeposits(function (error, result) {
          if (!error) {
            altDeposits = result;
            $('#raised_alt').html(''+formatThousandsNoRounding(web3.fromWei(result, 'ether'), 3)+' ETH');
            updateRaised();
          }
          else {
            console.log('Error: '+error);
          }
        });

        // Update hardcap
        web3.eth.getStorageAt(saleAddr, 5, function (error, result) {
          if (!error) {
            hardcap = result;
            $('#hardcap').html(formatThousandsNoRounding(web3.fromWei(result, 'ether'), 3)+' ETH');
            updateRaised();
          }
          else {
            console.log('Error: '+error);
          }
        });

        // Update minting state
        tokenContract.mintingFinished(function (error, result) {
          if (!error) {
            $('#minting_finished').html(result ? 'Yes' : 'No');
          }
          else {
            console.log('Error: '+error);
          }
        });

        tokenContract.totalSupply(function (error, result) {
          if (!error) {
            $('#supply').html(result+' PAY');
          }
          else {
            console.log('Error: '+error);
          }
        });

        tokenContract.tradingStarted(function (error, result) {
          if (!error) {
            $('#trading').html(result ? 'Yes' : 'No');
          }
          else {
            console.log('Error: '+error);
          }
        });

        tokenContract.balanceOf(ourAddr, function (error, result) {
          if (!error) {
            $('#our_tokens').html(''+result+' PAY');
          }
          else {
            console.log('Error: '+error);
          }
        });

        // Get latest block
        web3.eth.getBlock('latest', function (error, block) {
          if (!error) {
            var now = Math.floor(Date.now()/1000);

            $('#block_number').html(block.number);
            var age = now-block.timestamp;

            var d = Math.floor(age/86400);
            var h = Math.floor((age%86400)/3600);
            var m = Math.floor((age%3600)/60);
            var s = age%60;

            var ageReadable = '';
            if (d > 0) {
              ageReadable += d+'d ';
            }
            if (h > 0) {
              ageReadable += h+'h ';
            }
            if (m > 0) {
              ageReadable += m+'m ';
            }
            if (s > 0) {
              ageReadable += s+'s ';
            }

            $('#age').html(ageReadable);
          }
          else {
            console.log('Error: '+error);
          }
        });
      }

      $(window).on('load', function () {
        web3 = new Web3(new Web3.providers.HttpProvider(nodeURL));

        saleContract = web3.eth.contract(saleABI).at(saleAddr);
        rateContract = web3.eth.contract(rateABI).at(rateAddr);
        tokenContract = web3.eth.contract(tokenABI).at(tokenAddr);

        update();
        setInterval(function() { update(); }, 5000);
      });
    </script>
    <style>
      * {
        font-family: Verdana;
        line-height: 2em;
      }
      span {
        font-weight: bold;
      }
      .pre {
        color: orange;
      }
      .started {
        color: green;
        font-size: 1.5em;
      }
      .post {
        color: red;
      }
      .our_tokens {
        font-size: 1.3em;
      }
    </style>
  </head>
  <body>
    <p>
      Block number: <span id="block_number">?</span> Age: <span id="age">?</span><br /><br />

      ICO start: <span id="start">?</span><br />
      Status: <span id="status">?</span><br />
      Hardcap: <span id="hardcap">?</span><br />
      Raised: <span id="raised">?</span> <span id="raised_perc">?</span><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Main: <span id="raised_eth">?</span><br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Alt: <span id="raised_alt">?</span><br /><br />
      Minting finished: <span id="minting_finished"></span><br />
      Total supply: <span id="supply"></span><br />
      Trading started: <span id="trading"></span><br /><br />
      <span class="our_tokens">Our tokens: <span id="our_tokens"></span></span>
    </p>
  </body>
</html>